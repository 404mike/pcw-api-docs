# 1. Authentication

Authentication is achieved using OAuth (Open Authentication). This allows
users of the API to approve their application to act on their behalf without the
need to share or transmit passwords over HTTP. Once authenticated, the client
is capable of performing CRUD (Create, Read, Update, Delete) operations
programmatically.

A brief example of GET programmatic API usage can be seen here:

```php
<?php
define('BASE_URI', 'http://www.peoplescollection.wales/rest/v1/'); 
define('API_CONSUMER_KEY', '...'); 
define('API_CONSUMER_SECRET', '...'); 
define('API_ACCESS_TOKEN', '...'); 
define('API_ACCESS_TOKEN_SECRET', '...');

$oauth = new OAuth(
    API_CONSUMER_KEY,  
    API_CONSUMER_SECRET,  
    OAUTH_SIG_METHOD_HMACSHA1,  
    OAUTH_AUTH_TYPE_URI
);

$oauth->setToken(API_ACCESS_TOKEN, API_ACCESS_TOKEN_SECRET);

$query = '…';

$oauth->fetch(BASE_URI . $query);

print_r($oauth->getLastResponse());
```

For POST requests, the ```$oauth->fetch()``` is modified to carry the ```$postData``` array and utilise the ```OAUTH_HTTP_METHOD_POST:```

```php
<?php
define('BASE_URI', 'http://www.peoplescollection.wales/rest/v1/'); 
define('API_CONSUMER_KEY', '...'); 
define('API_CONSUMER_SECRET', '...'); 
define('API_ACCESS_TOKEN', '...'); 
define('API_ACCESS_TOKEN_SECRET', '...');

$oauth = new OAuth(
    API_CONSUMER_KEY, 
    API_CONSUMER_SECRET, 
    OAUTH_SIG_METHOD_HMACSHA1,
    OAUTH_AUTH_TYPE_URI 
);

$oauth->setToken(API_ACCESS_TOKEN, API_ACCESS_TOKEN_SECRET);

$query = '…';

$postData = array(
    // Data to post to API
);

$oauth->fetch(BASE_URI . $query, $postData, OAUTH_HTTP_METHOD_POST);

print_r($oauth->getLastResponse());
```

For the data that is contained within the ```$postData``` array for each type of
content, refer to the relevant section in the Endpoints chapter of the
documentation.

Responses are returned in JSON format (Javascript Object Notation).

## 1.1 Generating API Credentials

API credentials can be generated by any user with the API consumer role. Once
signed in, create a new consumer by providing a name and a callback URL, and
save; a key and a secret will be generated which will allow programmatic
access to the API.

> Direct link - http://www.peoplescollection.wales/user/3576/oauth/consumer 

> Replace 3576 with your user ID.

![alt text](https://github.com/404mike/pcw-api-docs/blob/master/images/consumer.jpg "PCW create consumer key")

Once both the consumer key and secret have been generated, it’s possible to
then request a request token and a request token secret. The code below
demonstrates this process:

```php
<?php
define('BASE_URI', 'http://www.peoplescollection.wales/rest/v1/'); 
define('API_CONSUMER_KEY', '...'); 
define('API_CONSUMER_SECRET', '...');

$oauth = new OAuth( 
    API_CONSUMER_KEY,
    API_CONSUMER_SECRET,
    OAUTH_SIG_METHOD_HMACSHA1, 
    OAUTH_AUTH_TYPE_URI 
);

$my_tokens = $oauth->getRequestToken(
    'http://www.peoplescollection.wales/oauth/request_token'
);

$oauth->setToken(
    $my_tokens['oauth_token'], 
    $my_tokens['oauth_token_secret']
);

// Redirect to authorise request token
header('Location: http://www.peoplescollection.wales/oauth/authorize?
        oauth_token=' . $my_tokens['oauth_token']);
```

The request token has a lifespan of 1 hour, and must be authorised (see line 23 above) before it can be used to request an access token.
Once a request token and request token secret have been requested and authorised, they can then be used to request an access token and access token secret. The code below demonstrates this process:

```php
<?php
define('API_CONSUMER_KEY', '...'); 
define('API_CONSUMER_SECRET', '...');

$request_token = '…';
$request_token_secret = '…';

$oauth = new OAuth( 
    API_CONSUMER_KEY,
    API_CONSUMER_SECRET,
    OAUTH_SIG_METHOD_HMACSHA1, 
    OAUTH_AUTH_TYPE_URI 
);

$oauth->setToken(
    $request_token, 
    $request_token_secret
);

$access_token = $oauth->getAccessToken(
    'http://www.peoplescollection.wales/oauth/access_token'
);
```

The access token does not have a lifespan, once requested it should be stored to be used for any future API calls.

## 1.2 Code example

Below is a full example of a one page script to handle authentication, obtaining an access token and making an API call. Sessions are used to store the request and access tokens and secrets - however, it is recommended that you store the access token and secret in permanent storage (i.e. database) once they are obtained. Try-catch blocks are also used to catch any errors that are returned by the API.

```php
<?php
session_start();

define('BASE_URL', 'http://www.peoplescollection.wales');
define('BASE_PATH', '/rest/v1/');
define('CONSUMER_KEY', '...');
define('CONSUMER_SECRET', '...');

$oauth = new OAuth(CONSUMER_KEY, CONSUMER_SECRET, OAUTH_SIG_METHOD_HMACSHA1, OAUTH_AUTH_TYPE_URI);

if (!isset($_SESSION['request_token']) && !isset($_SESSION['access_token'])) {
    
    // Get a request token required to exchange for an access token
    $requestToken = $oauth->getRequestToken(BASE_URL . '/oauth/request_token');
    
    // Save the request token in a session as it will be
    // needed when returning after authorisation
    $_SESSION['request_token'] = $requestToken;
    
    // Redirect to authorise token URL
    header('Location: ' . BASE_URL . '/oauth/authorize?oauth_token=' . $requestToken['oauth_token']);
    
} elseif (isset($_SESSION['request_token']) && !isset($_SESSION['access_token'])) {
    
    // Set the request token to exchange for an access token
    $oauth->setToken($_SESSION['request_token']['oauth_token'], $_SESSION['request_token']['oauth_token_secret']);
    
    // Unset request token in session to prevent attempt to reuse
    unset($_SESSION['request_token']);
    
    // Get an access token required to request resources
    $accessToken = $oauth->getAccessToken(BASE_URL . '/oauth/access_token');
    
    // Save access token in a session to use for all 
    // subsequent resource requests
    $_SESSION['access_token'] = $accessToken;
    
    // Set access token for all subsequent API calls
    $oauth->setToken($accessToken['oauth_token'], $accessToken['oauth_token_secret']);
    
} else {
    
    // Set access token for all subsequent API calls
    $oauth->setToken($_SESSION['access_token']['oauth_token'], $_SESSION['access_token']['oauth_token_secret']);
    
}

// API query
$query = 'item';

// Post data
$postData = array(
  // Data to post to API
);

try {
    // Make API call
    $oauth->fetch(BASE_URL . BASE_PATH . $query, $postData);
    
    // Format and display results
    $result = json_decode($oauth->getLastResponse(), true);
    echo '<pre>', print_r($result), '</pre>';
}
catch (OAuthException $e) {
    // Print exception message
    echo $e->getMessage();
}
```
